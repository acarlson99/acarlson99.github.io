MB_SOURCES = $(wildcard research/*.md)
IPY_SOURCES = $(wildcard research/*.ipynb)
HTML_TEMPLATE_SOUCES = src/rosh_template.html
TARGETS =	$(patsubst research/%.md,static/research/%.html,${MB_SOURCES}) \
			$(patsubst research/%.ipynb,static/research/%.html,${IPY_SOURCES}) \
			$(patsubst src/%_template.html,static/%.html,${HTML_TEMPLATE_SOUCES}) \
			index.html \
			static/prettypattern_1.txt

DOTA_TIMES_OUT = tmp/dota-times-out
DOTA_TIMES_SRC = ./scripts/dota-times.hs
DYALOG_TILE_OUT = tmp/dyalog-tile-out
DYALOG_TILE_SRC = ./scripts/tile.dyalog
TILE_HS = ./scripts/tile.hs
PLACEHOLDER_REPLACE_SH = ./scripts/replace-placeholders.sh
ESCAPE_SH = ./scripts/escape.sh
TMP_FILES = ${DOTA_TIMES_OUT} ${DYALOG_TILE_OUT}
TMP_DIR = tmp/
RESEARCH_OUT_DIR = static/research
BUILD_DIRS = ${RESEARCH_OUT_DIR} ${TMP_DIR}

all: depcheck ${BUILD_DIRS} ${TARGETS}

depcheck:
	pandoc -v
	runhaskell --version
	sed --version
	which dyalogscript

${BUILD_DIRS}:
	mkdir -p $@

# previously
# find . -iname '*.md' -exec bash -c 'mdtohtml "$1" "${1/%.md/.html}"' _ {} '.html' ';'
static/research/%.html: research/%.md ${RESEARCH_OUT_DIR}
	pandoc --standalone --css=/style.css $< --metadata pagetitle=$(notdir $(basename $<)) -o $@
	sed -i '1i<!-- generated by $< -->' $@

static/research/%.html: research/%.ipynb ${RESEARCH_OUT_DIR}
	jupyter nbconvert $< --stdout --to html --embed-images --theme dark > $@
	sed -i '1i<!-- generated by $< -->' $@

${DOTA_TIMES_OUT}: ${DOTA_TIMES_SRC} ${TMP_DIR}
	runhaskell $< html 35 > ${DOTA_TIMES_OUT}
	sed -i '1i<!-- generated by $< -->' $@

static/rosh.html: src/rosh_template.html ${DOTA_TIMES_OUT} ${PLACEHOLDER_REPLACE_SH}
	bash ${PLACEHOLDER_REPLACE_SH} $< DOTA_TIMES_HS ${DOTA_TIMES_OUT} > $@
	sed -i '1i<!-- generated by $< -->' $@

${DYALOG_TILE_OUT}: ${DYALOG_TILE_SRC} ${TMP_DIR}
	dyalogscript $< | bash ${ESCAPE_SH} '\\' > ${DYALOG_TILE_OUT}

static/prettypattern_1.txt: ${TILE_HS}
	runhaskell $< -d6 --walk -o $@
	sed -i '1i<!-- generated by $< -->' $@

index.html: src/index_template.html ${DYALOG_TILE_OUT} ${PLACEHOLDER_REPLACE_SH}
	bash ${PLACEHOLDER_REPLACE_SH} $< DYALOG_TILE_DATA ${DYALOG_TILE_OUT} > $@
	sed -i '1i<!-- generated by $< -->' $@

clean:
	${RM} ${TARGETS} ${TMP_FILES}
	rmdir ${BUILD_DIRS} > /dev/null 2>&1 || true

re: clean all

host: all
	php -S localhost:8080
serve: host
